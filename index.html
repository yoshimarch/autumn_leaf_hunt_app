<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§‹ã®è‘‰ã£ã±é›†ã‚</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      background-color: #fff8e1;
      color: #5d4037;
      line-height: 1.6;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 15px;
    }
    
    @media (min-width: 600px) {
      .container {
        max-width: 800px;
        padding: 20px;
      }
    }
    
    header {
      text-align: center;
      margin-bottom: 15px;
    }
    
    h1 {
      color: #e65100;
      font-size: 1.8rem;
      margin-bottom: 8px;
    }
    
    h2 {
      color: #f57c00;
      font-size: 1.3rem;
      margin: 12px 0;
    }
    
    h3 {
      color: #e65100;
      font-size: 1.1rem;
      margin: 8px 0;
    }
    
    p {
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .bingo-card {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 15px 0;
    }
    
    .bingo-cell {
      aspect-ratio: 1/1;
      border: 2px dashed #ff6f00;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #fffde7;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .bingo-cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .selected {
      border: 2px solid #f57f17;
      box-shadow: 0 0 10px rgba(245, 127, 23, 0.5);
    }
    
    .empty-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      color: #8d6e63;
    }
    
    .filled-cell {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .leaf-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .leaf-note {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 5px;
      font-size: 12px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .leaf-collection {
      margin: 15px 0;
    }
    
    .leaf-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .leaf-thumbnail {
      width: 70px;
      height: 70px;
      border: 1px solid #ffa000;
      border-radius: 5px;
      overflow: hidden;
      cursor: grab;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    @media (min-width: 600px) {
      .leaf-thumbnail {
        width: 80px;
        height: 80px;
      }
    }
    
    .leaf-thumbnail:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .leaf-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .thumbnail-note {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 2px;
      font-size: 10px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-height: 20px;
    }
    
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
      justify-content: center;
    }
    
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .save-button {
      background-color: #7cb342;
      color: white;
      flex: 1;
    }
    
    .nft-button {
      background-color: #9e9e9e;
      color: white;
      flex: 1;
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .nft-button-enabled {
      opacity: 1;
      cursor: pointer;
    }
    
    .clear-button {
      background-color: #ef5350;
      color: white;
      flex: 1;
    }
    
    button:hover:not([disabled]):not(.nft-button) {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nft-button-enabled:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nft-message {
      margin: 15px 0;
      padding: 12px;
      background-color: #e1f5fe;
      border-left: 4px solid #29b6f6;
      border-radius: 4px;
      animation: fadeIn 0.5s ease-in;
      font-size: 14px;
    }
    
    .storage-warning {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .data-notice {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .save-info {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .seasonal-info {
      margin-top: 20px;
      padding: 12px;
      background-color: #ffecb3;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .seasonal-info ul {
      padding-left: 20px;
      margin-top: 5px;
    }
    
    .seasonal-info li {
      margin-bottom: 3px;
    }
    
    .memo-tips {
      background-color: #f3e5f5;
      border-left: 4px solid #9c27b0;
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .memo-tips ul {
      padding-left: 20px;
      margin-top: 5px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-in;
    }
    
    .modal-content {
      background-color: white;
      padding: 15px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease-out;
    }
    
    .modal-content h3 {
      margin-top: 0;
      color: #e65100;
    }
    
    .modal-content textarea {
      width: 100%;
      height: 80px;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ffa000;
      border-radius: 5px;
      resize: none;
      font-family: inherit;
      font-size: 14px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    
    .cancel-button {
      background-color: #9e9e9e;
      color: white;
    }
    
    .save-note-button {
      background-color: #ff9800;
      color: white;
    }
    
    .leaf-preview {
      width: 100px;
      height: 100px;
      margin: 0 auto 10px;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid #ffa000;
    }
    
    .leaf-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .char-count {
      text-align: right;
      font-size: 12px;
      color: #757575;
      margin-top: 5px;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      color: #8d6e63;
      font-size: 0.8rem;
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* ã‚¹ãƒãƒ›å¯¾å¿œã®ãŸã‚ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      .bingo-card {
        gap: 5px;
      }
      
      .empty-cell span {
        font-size: 12px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        padding: 12px 0;
      }
      
      .leaf-thumbnail {
        width: 60px;
        height: 60px;
      }
    }
    
    /* é•·æŠ¼ã—ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ï¼ˆã‚¹ãƒãƒ›ã§ã®å³ã‚¯ãƒªãƒƒã‚¯ç›¸å½“ã®æ“ä½œï¼‰ */
    .leaf-thumbnail {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* ã‚¹ãƒãƒ›å‘ã‘ã®å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .delete-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #f44336;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      z-index: 2;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .leaf-thumbnail:hover .delete-badge,
    .leaf-thumbnail:active .delete-badge {
      opacity: 1;
    }

    /* ä¿å­˜ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* è¿½åŠ ï¼šæ—¥ä»˜å…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ« */
    .date-input {
      margin-top: 8px;
      font-size: 14px;
    }

    .date-input input {
      padding: 5px;
      border: 1px solid #ffa000;
      border-radius: 4px;
      font-family: inherit;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ ç§‹ã®è‘‰ã£ã±é›†ã‚ ğŸ‚</h1>
      <p>è‘‰ã£ã±ã‚’9æšé›†ã‚ã¦ã€ã‚ãªãŸã ã‘ã®ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</p>
    </header>
    
    <main>
      <div class="data-notice">
        <p>ğŸ“± <strong>ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«ã¤ã„ã¦ã®æ³¨æ„:</strong> ã“ã®ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã‚Šåˆ¥ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å±¥æ­´ã‚’æ¶ˆå»ã™ã‚‹ã¨ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚å¤±ã‚ã‚Œã¾ã™ã€‚ä½œæˆã—ãŸã‚«ãƒ¼ãƒ‰ã¯ã€ŒJPEGã¨ã—ã¦ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ç”»åƒã¨ã—ã¦ä¿å­˜ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</p>
      </div>

      <div class="save-info" id="saveInfo" style="display: none;">
        <p>ğŸ’¾ <strong>ä¿å­˜å ´æ‰€:</strong> ã€ŒJPEGã¨ã—ã¦ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚©ãƒ«ãƒ€ã«ã€Œç§‹ã®è‘‰ã£ã±ãƒ“ãƒ³ã‚´.jpgã€ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä¿å­˜å ´æ‰€ã¯ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã«ã‚ˆã£ã¦ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
      </div>
      
      <div id="storageWarning" class="storage-warning" style="display: none;">
        <p>âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒåˆ¶é™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚æ–°ã—ã„è‘‰ã£ã±ã‚’è¿½åŠ ã™ã‚‹å‰ã«ã€å¤ã„è‘‰ã£ã±ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</p>
      </div>
      
      <div class="bingo-card-container">
        <h2>ã‚ãªãŸã®è‘‰ã£ã±ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>
        <div class="bingo-card" id="bingoCard">
          <!-- JavaScriptã§ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®ã‚»ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
      </div>
      
      <div class="action-buttons">
        <button id="saveJpegBtn" class="save-button">JPEGã¨ã—ã¦ä¿å­˜ ğŸ’¾</button>
        <button id="saveNftBtn" class="nft-button" disabled>NFTã¨ã—ã¦ä¿å­˜ï¼ˆæœªå®Ÿè£…ï¼‰ğŸŒŸ</button>
        <button id="clearBtn" class="clear-button">ãƒªã‚»ãƒƒãƒˆ ğŸ—‘ï¸</button>
      </div>
      
      <div id="nftMessage" class="nft-message" style="display:none;"></div>
      
      <div id="leafCollection" class="leaf-collection" style="display:none;">
        <h2>ã‚ãªãŸã®è‘‰ã£ã±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
        <p>è‘‰ã£ã±ã‚’ã‚¿ãƒƒãƒ—ã§ãƒ¡ãƒ¢ã‚’ç·¨é›†ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã«é…ç½®ã€âŒãƒãƒ¼ã‚¯ã§å‰Šé™¤ã§ãã¾ã™</p>
        <div class="leaf-gallery" id="leafGallery">
          <!-- JavaScriptã§è‘‰ã£ã±ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
      </div>
      
      <div class="seasonal-info">
        <h3>ğŸ‚ ç§‹ã®è‘‰ã£ã±ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼ ğŸ‚</h3>
        <p>ç©ºã®ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è‘‰ã£ã±ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å®Œæˆã•ã›ã¾ã—ã‚‡ã†ã€‚å„è‘‰ã£ã±ã«ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¦ã€ç™ºè¦‹ã—ãŸå ´æ‰€ã‚„æ„Ÿæƒ³ã‚’è¨˜éŒ²ã§ãã¾ã™ã€‚</p>
        <ul>
          <li>ã‚¤ãƒãƒ§ã‚¦ - é»„è‰²ã®æ‰‡å½¢ã®è‘‰</li>
          <li>ãƒ¢ãƒŸã‚¸ - èµ¤è‰²ã®æ‰‹ã®ã²ã‚‰å‹ã®è‘‰</li>
          <li>ã‚«ã‚¨ãƒ‡ - æ˜Ÿå½¢ã®è‘‰</li>
          <li>ã‚¯ãƒŒã‚® - æ³¢æ‰“ã£ãŸç¸ã®è‘‰</li>
          <li>ã‚±ãƒ¤ã‚­ - ç´°é•·ã„æ¥•å††å½¢ã®è‘‰</li>
        </ul>
      </div>
    </main>
    
    <footer>
      <p>Â© 2025 ç§‹ã®è‘‰ã£ã±é›†ã‚ - ã™ã¹ã¦ã®æ¨©åˆ©ã¯ç§‹ã®å¦–ç²¾ã«å¸°å±ã—ã¾ã™ ğŸ‚</p>
    </footer>
    
    <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
    <input type="file" id="fileInput" style="display: none;" accept="image/*" multiple>
    
    <!-- éè¡¨ç¤ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”»åƒå‡¦ç†ç”¨ï¼‰ -->
    <canvas id="canvas" style="display: none;"></canvas>
  </div>
  
  <!-- ãƒ¡ãƒ¢å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="noteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>è‘‰ã£ã±ã®ãƒ¡ãƒ¢ã‚’è¿½åŠ </h3>
      <div class="leaf-preview" id="leafPreview">
        <!-- é¸æŠã—ãŸè‘‰ã£ã±ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ -->
      </div>
      
      <div class="memo-tips">
        <p><strong>ãƒ¡ãƒ¢ã®ãƒ’ãƒ³ãƒˆ:</strong> ä»¥ä¸‹ã®æƒ…å ±ã‚’è¨˜éŒ²ã—ã¦ãŠãã¨ã€å¾Œã§æ€ã„å‡ºã™åŠ©ã‘ã«ãªã‚Šã¾ã™</p>
        <ul>
          <li>ç™ºè¦‹ã—ãŸå ´æ‰€ï¼ˆå…¬åœ’åã€å±±ã®åå‰ãªã©ï¼‰</li>
          <li>æ¨¹æœ¨ã®ç¨®é¡ï¼ˆã‚ã‹ã‚‹å ´åˆï¼‰</li>
          <li>è‘‰ã£ã±ã®ç‰¹å¾´ã‚„è‰²</li>
          <li>è¦‹ã¤ã‘ãŸã¨ãã®æ€ã„å‡º</li>
        </ul>
      </div>
      
      <textarea id="noteInput" placeholder="ã“ã®è‘‰ã£ã±ã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç™ºè¦‹å ´æ‰€ã€æ¤ç‰©åã€æ„Ÿæƒ³ãªã©ï¼‰" maxlength="50"></textarea>
      <div class="date-input">
        <label for="dateInput">ç™ºè¦‹æ—¥: </label>
        <input type="date" id="dateInput">
      </div>
      <div class="char-count"><span id="charCount">0</span>/50æ–‡å­—</div>
      <div class="modal-buttons">
        <button id="cancelNoteBtn" class="cancel-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="saveNoteBtn" class="save-note-button">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- NFTæ©Ÿèƒ½æœ‰åŠ¹åŒ–ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå°†æ¥çš„ãªæ‹¡å¼µç”¨ï¼‰ -->
  <div id="nftEnableModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>NFTæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–</h3>
      <p>ã‚ãªãŸã®ç§‹ã®è‘‰ã£ã±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’NFTã¨ã—ã¦ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ</p>
      <p>ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã¨ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã«ã‚ãªãŸã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²ã—ã€ãƒ‡ã‚¸ã‚¿ãƒ«è³‡ç”£ã¨ã—ã¦æ‰€æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      
      <div class="modal-buttons">
        <button id="cancelNftEnableBtn" class="cancel-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="confirmNftEnableBtn" class="save-note-button">æœ‰åŠ¹åŒ–ã™ã‚‹</button>
      </div>
    </div>
  </div>
  
  <script>
    // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç”»åƒã«å¤‰æ›ã™ã‚‹é–¢æ•°
    // â€»æ³¨: html2canvasã®å®Œå…¨ãªä»£æ›¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ãªè¦ç´ ã®ç”»åƒåŒ–ã«ä½¿ç”¨å¯èƒ½
    function captureElement(element) {
      return new Promise((resolve, reject) => {
        try {
          // å¯¾è±¡è¦ç´ ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
          const rect = element.getBoundingClientRect();
          const width = rect.width;
          const height = rect.height;
          
          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
          const canvas = document.createElement('canvas');
          canvas.width = width * 2; // é«˜è§£åƒåº¦ã®ãŸã‚2å€
          canvas.height = height * 2;
          
          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
          const ctx = canvas.getContext('2d');
          ctx.scale(2, 2); // é«˜è§£åƒåº¦ã®ãŸã‚2å€ã«ã‚¹ã‚±ãƒ¼ãƒ«
          
          // èƒŒæ™¯è‰²ã‚’è¨­å®š
          ctx.fillStyle = '#fff8e1';
          ctx.fillRect(0, 0, width, height);
          
          // HTMLã‚’ç”»åƒã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          const images = [];
          const cells = element.querySelectorAll('.bingo-cell');
          
          // å„ã‚»ãƒ«ã®ä½ç½®ã‚’è¨ˆç®—ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          let loadedImages = 0;
          const totalCells = cells.length;
          
          cells.forEach((cell, index) => {
            const cellRect = cell.getBoundingClientRect();
            const x = cellRect.left - rect.left;
            const y = cellRect.top - rect.top;
            const w = cellRect.width;
            const h = cellRect.height;
            
            // ã‚»ãƒ«ã®èƒŒæ™¯ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã‚’æç”»
            ctx.fillStyle = '#fffde7';
            ctx.strokeStyle = '#ff6f00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, 8);
            ctx.fill();
            ctx.stroke();
            
            // ã‚»ãƒ«å†…ã«ç”»åƒãŒã‚ã‚Œã°æç”»
            const img = cell.querySelector('img');
            if (img) {
              const tempImg = new Image();
              tempImg.crossOrigin = 'Anonymous';
              tempImg.onload = () => {
                ctx.drawImage(tempImg, x, y, w, h);
                
                // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°æç”»
                const noteDiv = cell.querySelector('.leaf-note');
                if (noteDiv) {
                  // ãƒ¡ãƒ¢ã®èƒŒæ™¯ã‚’æç”»
                  ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                  ctx.fillRect(x, y + h - 20, w, 20);
                  
                  // ãƒ¡ãƒ¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
                  ctx.fillStyle = 'white';
                  ctx.font = '12px sans-serif';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.fillText(noteDiv.textContent, x + w/2, y + h - 10, w - 4);
                }
                
                loadedImages++;
                if (loadedImages === totalCells) {
                  resolve(canvas);
                }
              };
              
              tempImg.onerror = () => {
                // ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã‚‚ç¶šè¡Œ
                console.error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', img.src);
                loadedImages++;
                if (loadedImages === totalCells) {
                  resolve(canvas);
                }
              };
              
              tempImg.src = img.src;
            } else {
              // ç”»åƒãŒãªã„å ´åˆã¯ç©ºã®ã‚»ãƒ«ã¨ã—ã¦æç”»
              ctx.fillStyle = '#8d6e63';
              ctx.font = '12px sans-serif';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText('ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è‘‰ã£ã±ã‚’è¿½åŠ ', x + w/2, y + h/2, w - 10);
              
              loadedImages++;
              if (loadedImages === totalCells) {
                resolve(canvas);
              }
            }
          });
          
          // ç”»åƒãŒãªã„å ´åˆï¼ˆã™ã¹ã¦ã®ã‚»ãƒ«ãŒç©ºï¼‰
          if (totalCells === 0 || document.querySelectorAll('.bingo-cell img').length === 0) {
            resolve(canvas);
          }
        } catch (error) {
          reject(error);
        }
      });
    }

    // çŠ¶æ…‹ç®¡ç†
    const state = {
      bingoCard: Array(9).fill(null),
      uploadedLeaves: [],
      leafNotes: {},
      leafDates: {},
      selectedCell: null,
      selectedLeafIndex: null,
      isTouchDevice: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
      nftEnabled: false, // NFTæ©Ÿèƒ½ãŒæœ‰åŠ¹ã‹ã©ã†ã‹
      isFirstSave: true // åˆå›ä¿å­˜ã‹ã©ã†ã‹
    };
    
    // DOMè¦ç´ 
    const elements = {
      bingoCard: document.getElementById('bingoCard'),
      fileInput: document.getElementById('fileInput'),
      saveJpegBtn: document.getElementById('saveJpegBtn'),
      saveNftBtn: document.getElementById('saveNftBtn'),
      clearBtn: document.getElementById('clearBtn'),
      leafGallery: document.getElementById('leafGallery'),
      leafCollection: document.getElementById('leafCollection'),
      noteModal: document.getElementById('noteModal'),
      noteInput: document.getElementById('noteInput'),
      dateInput: document.getElementById('dateInput'),
      leafPreview: document.getElementById('leafPreview'),
      cancelNoteBtn: document.getElementById('cancelNoteBtn'),
      saveNoteBtn: document.getElementById('saveNoteBtn'),
      nftMessage: document.getElementById('nftMessage'),
      charCount: document.getElementById('charCount'),
      canvas: document.getElementById('canvas'),
      storageWarning: document.getElementById('storageWarning'),
      saveInfo: document.getElementById('saveInfo'),
      nftEnableModal: document.getElementById('nftEnableModal'),
      cancelNftEnableBtn: document.getElementById('cancelNftEnableBtn'),
      confirmNftEnableBtn: document.getElementById('confirmNftEnableBtn')
    };
    
    // IndexedDBã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
    const DB_NAME = 'AutumnLeafHuntDB_v2'; // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’å¤‰æ›´ã—ã¦äº’æ›æ€§å•é¡Œã‚’å›é¿
    const DB_VERSION = 1;
    const LEAF_STORE = 'leaves';
    const CARD_STORE = 'bingoCard';
    const NOTES_STORE = 'notes';
    const DATES_STORE = 'dates';
    const CONFIG_STORE = 'config';
    
    // ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
    async function migrateFromOldDatabase() {
      try {
        // ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const oldDbRequest = indexedDB.open('AutumnLeafHuntDB', 1);
        
        oldDbRequest.onsuccess = async (event) => {
          const oldDb = event.target.result;
          
          // ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒˆã‚¢ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (oldDb.objectStoreNames.contains(LEAF_STORE) && 
              oldDb.objectStoreNames.contains(CARD_STORE) && 
              oldDb.objectStoreNames.contains(NOTES_STORE)) {
            
            try {
              // è‘‰ã£ã±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
              const leaves = await getAllFromStore(oldDb, LEAF_STORE);
              
              // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
              const cardData = await getFromStore(oldDb, CARD_STORE, 'current');
              
              // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
              const notes = await getAllFromStore(oldDb, NOTES_STORE);
              
              // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
              if (leaves.length > 0) {
                const newDb = await initDatabase();
                
                // è‘‰ã£ã±ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                for (const leaf of leaves) {
                  await addToStore(newDb, LEAF_STORE, leaf);
                }
                
                // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                if (cardData) {
                  await putToStore(newDb, CARD_STORE, cardData);
                }
                
                // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                for (const note of notes) {
                  await putToStore(newDb, NOTES_STORE, note);
                }
                
                // ç§»è¡ŒæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                console.log('ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œã«æˆåŠŸã—ã¾ã—ãŸ');
                showMessage('ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ç§»è¡Œã—ã¾ã—ãŸ');
                setTimeout(() => {
                  elements.nftMessage.style.display = 'none';
                }, 3000);
              }
            } catch (error) {
              console.error('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¨ãƒ©ãƒ¼:', error);
            }
          }
          
          // å¤ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‰ã˜ã‚‹
          oldDb.close();
        };
        
        oldDbRequest.onerror = (event) => {
          console.log('ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å­˜åœ¨ã—ã¾ã›ã‚“');
        };
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ã‚¹ãƒˆã‚¢ã‹ã‚‰ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getAllFromStore(db, storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = () => {
          resolve(request.result);
        };
        
        request.onerror = (event) => {
          reject(`${storeName}ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${event.target.error}`);
        };
      });
    }
    
    // ã‚¹ãƒˆã‚¢ã‹ã‚‰ç‰¹å®šã®ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getFromStore(db, storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(key);
        
        request.onsuccess = () => {
          resolve(request.result);
        };
        
        request.onerror = (event) => {
          reject(`${storeName}ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${event.target.error}`);
        };
      });
    }
    
    // ã‚¹ãƒˆã‚¢ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addToStore(db, storeName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.add(data);
        
        request.onsuccess = () => {
          resolve(request.result);
        };
        
        request.onerror = (event) => {
          reject(`${storeName}ã¸ã®ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${event.target.error}`);
        };
      });
    }
    
    // ã‚¹ãƒˆã‚¢ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function putToStore(db, storeName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        
        request.onsuccess = () => {
          resolve(request.result);
        };
        
        request.onerror = (event) => {
          reject(`${storeName}ã¸ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${event.target.error}`);
        };
      });
    }
    
    // IndexedDBã‚’åˆæœŸåŒ–
    function initDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = (event) => {
          console.error('IndexedDBã‚¨ãƒ©ãƒ¼:', event.target.error);
          reject('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚');
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // è‘‰ã£ã±ç”»åƒã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains(LEAF_STORE)) {
            db.createObjectStore(LEAF_STORE, { keyPath: 'id', autoIncrement: true });
          }
          
          // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains(CARD_STORE)) {
            db.createObjectStore(CARD_STORE, { keyPath: 'id' });
          }
          
          // ãƒ¡ãƒ¢ã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains(NOTES_STORE)) {
            db.createObjectStore(NOTES_STORE, { keyPath: 'id' });
          }
          
          // æ—¥ä»˜ã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains(DATES_STORE)) {
            db.createObjectStore(DATES_STORE, { keyPath: 'id' });
          }
          
          // è¨­å®šã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains(CONFIG_STORE)) {
            db.createObjectStore(CONFIG_STORE, { keyPath: 'id' });
          }
        };
        
        request.onsuccess = (event) => {
          const db = event.target.result;
          resolve(db);
        };
      });
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è‘‰ã£ã±ã‚’ä¿å­˜
    async function saveLeafToDb(imageDataURL) {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([LEAF_STORE], 'readwrite');
          const store = transaction.objectStore(LEAF_STORE);
          
          const leaf = { imageData: imageDataURL };
          const request = store.add(leaf);
          
          request.onsuccess = (event) => {
            resolve(event.target.result); // ä¿å­˜ã—ãŸè‘‰ã£ã±ã®ID
          };
          
          request.onerror = (event) => {
            console.error('è‘‰ã£ã±ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('è‘‰ã£ã±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        throw error;
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã™ã¹ã¦ã®è‘‰ã£ã±ã‚’èª­ã¿è¾¼ã¿
    async function loadLeavesFromDb() {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([LEAF_STORE], 'readonly');
          const store = transaction.objectStore(LEAF_STORE);
          
          const request = store.getAll();
          
          request.onsuccess = (event) => {
            const leaves = event.target.result.map(leaf => ({
              id: leaf.id,
              imageData: leaf.imageData
            }));
            resolve(leaves);
          };
          
          request.onerror = (event) => {
            console.error('è‘‰ã£ã±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('è‘‰ã£ã±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return [];
      }
    }
    
    // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜
    async function saveBingoCardToDb() {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CARD_STORE], 'readwrite');
          const store = transaction.objectStore(CARD_STORE);
          
          // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®IDã¨è‘‰ã£ã±IDã®å¯¾å¿œã‚’ä¿å­˜
          const cardData = {
            id: 'current',
            cells: state.bingoCard.map(cellData => {
              if (!cellData) return null;
              const leafIndex = state.uploadedLeaves.findIndex(leaf => leaf.imageData === cellData);
              return leafIndex !== -1 ? state.uploadedLeaves[leafIndex].id : null;
            })
          };
          
          const request = store.put(cardData);
          
          request.onsuccess = () => {
            resolve();
          };
          
          request.onerror = (event) => {
            console.error('ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
    async function loadBingoCardFromDb() {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CARD_STORE], 'readonly');
          const store = transaction.objectStore(CARD_STORE);
          
          const request = store.get('current');
          
          request.onsuccess = (event) => {
            const cardData = event.target.result;
            if (cardData && cardData.cells) {
              resolve(cardData.cells);
            } else {
              resolve(Array(9).fill(null));
            }
          };
          
          request.onerror = (event) => {
            console.error('ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return Array(9).fill(null);
      }
    }
    
    // ãƒ¡ãƒ¢ã‚’ä¿å­˜
    async function saveNoteToDb(leafId, note) {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([NOTES_STORE], 'readwrite');
          const store = transaction.objectStore(NOTES_STORE);
          
          const noteData = { id: leafId, text: note };
          const request = store.put(noteData);
          
          request.onsuccess = () => {
            resolve();
          };
          
          request.onerror = (event) => {
            console.error('ãƒ¡ãƒ¢ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // æ—¥ä»˜ã‚’ä¿å­˜
    async function saveDateToDb(leafId, date) {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([DATES_STORE], 'readwrite');
          const store = transaction.objectStore(DATES_STORE);
          
          const dateData = { id: leafId, date: date };
          const request = store.put(dateData);
          
          request.onsuccess = () => {
            resolve();
          };
          
          request.onerror = (event) => {
            console.error('æ—¥ä»˜ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('æ—¥ä»˜ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // è¨­å®šã‚’ä¿å­˜
    async function saveConfigToDb(key, value) {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readwrite');
          const store = transaction.objectStore(CONFIG_STORE);
          
          const config = { id: key, value: value };
          const request = store.put(config);
          
          request.onsuccess = () => {
            resolve();
          };
          
          request.onerror = (event) => {
            console.error('è¨­å®šã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadConfigFromDb(key) {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readonly');
          const store = transaction.objectStore(CONFIG_STORE);
          
          const request = store.get(key);
          
          request.onsuccess = (event) => {
            const config = event.target.result;
            if (config) {
              resolve(config.value);
            } else {
              resolve(null);
            }
          };
          
          request.onerror = (event) => {
            console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }
    
    // ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
    async function loadNotesFromDb() {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([NOTES_STORE], 'readonly');
          const store = transaction.objectStore(NOTES_STORE);
          
          const request = store.getAll();
          
          request.onsuccess = (event) => {
            const notes = {};
            event.target.result.forEach(note => {
              notes[note.id] = note.text;
            });
            resolve(notes);
          };
          
          request.onerror = (event) => {
            console.error('ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return {};
      }
    }
    
    // ã™ã¹ã¦ã®æ—¥ä»˜ã‚’èª­ã¿è¾¼ã¿
    async function loadDatesFromDb() {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([DATES_STORE], 'readonly');
          const store = transaction.objectStore(DATES_STORE);
          
          const request = store.getAll();
          
          request.onsuccess = (event) => {
            const dates = {};
            event.target.result.forEach(date => {
              dates[date.id] = date.date;
            });
            resolve(dates);
          };
          
          request.onerror = (event) => {
            console.error('æ—¥ä»˜ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('æ—¥ä»˜ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return {};
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç‰¹å®šã®è‘‰ã£ã±ã‚’å‰Šé™¤
    async function deleteLeafFromDb(leafId) {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([LEAF_STORE, NOTES_STORE, DATES_STORE], 'readwrite');
          const leafStore = transaction.objectStore(LEAF_STORE);
          const noteStore = transaction.objectStore(NOTES_STORE);
          const dateStore = transaction.objectStore(DATES_STORE);
          
          // è‘‰ã£ã±ã‚’å‰Šé™¤
          const leafRequest = leafStore.delete(leafId);
          
          leafRequest.onsuccess = () => {
            // é–¢é€£ã™ã‚‹ãƒ¡ãƒ¢ã‚‚å‰Šé™¤
            const noteRequest = noteStore.delete(leafId);
            
            noteRequest.onsuccess = () => {
              // é–¢é€£ã™ã‚‹æ—¥ä»˜ã‚‚å‰Šé™¤
              const dateRequest = dateStore.delete(leafId);
              
              dateRequest.onsuccess = () => {
                resolve();
              };
              
              dateRequest.onerror = (event) => {
                console.error('æ—¥ä»˜ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', event.target.error);
                // æ—¥ä»˜ã®å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
                resolve();
              };
            };
            
            noteRequest.onerror = (event) => {
              console.error('ãƒ¡ãƒ¢ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', event.target.error);
              // ãƒ¡ãƒ¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
              resolve();
            };
          };
          
          leafRequest.onerror = (event) => {
            console.error('è‘‰ã£ã±ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('è‘‰ã£ã±ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
    async function clearDatabase() {
      try {
        const db = await initDatabase();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([LEAF_STORE, CARD_STORE, NOTES_STORE, DATES_STORE], 'readwrite');
          const leafStore = transaction.objectStore(LEAF_STORE);
          const cardStore = transaction.objectStore(CARD_STORE);
          const noteStore = transaction.objectStore(NOTES_STORE);
          const dateStore = transaction.objectStore(DATES_STORE);
          
          // ã™ã¹ã¦ã®ã‚¹ãƒˆã‚¢ã‚’ã‚¯ãƒªã‚¢
          const leafRequest = leafStore.clear();
          const cardRequest = cardStore.clear();
          const noteRequest = noteStore.clear();
          const dateRequest = dateStore.clear();
          
          let completedStores = 0;
          const checkComplete = () => {
            completedStores++;
            if (completedStores === 4) {
              resolve();
            }
          };
          
          leafRequest.onsuccess = checkComplete;
          cardRequest.onsuccess = checkComplete;
          noteRequest.onsuccess = checkComplete;
          dateRequest.onsuccess = checkComplete;
          
          leafRequest.onerror = (event) => {
            console.error('è‘‰ã£ã±ã‚¹ãƒˆã‚¢ã®ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', event.target.error);
            reject('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          };
          
          transaction.oncomplete = () => {
            db.close();
          };
        });
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ã™ã¹ã¦èª­ã¿è¾¼ã¿
    async function loadAppState() {
      try {
        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®ãƒã‚§ãƒƒã‚¯
        await migrateFromOldDatabase();
        
        // è‘‰ã£ã±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const leaves = await loadLeavesFromDb();
        state.uploadedLeaves = leaves;
        
        // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
        const cardCells = await loadBingoCardFromDb();
        
        // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®ã‚»ãƒ«ã‚’è¨­å®š
        state.bingoCard = Array(9).fill(null);
        cardCells.forEach((leafId, index) => {
          if (leafId !== null) {
            const leaf = state.uploadedLeaves.find(l => l.id === leafId);
            if (leaf) {
              state.bingoCard[index] = leaf.imageData;
            }
          }
        });
        
        // ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
        state.leafNotes = await loadNotesFromDb();
        
        // æ—¥ä»˜ã‚’èª­ã¿è¾¼ã¿
        state.leafDates = await loadDatesFromDb();
        
        // NFTæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
        const nftEnabled = await loadConfigFromDb('nftEnabled');
        if (nftEnabled !== null) {
          state.nftEnabled = nftEnabled;
          if (nftEnabled) {
            enableNftButton();
          }
        }
        
        // åˆå›ä¿å­˜ãƒ•ãƒ©ã‚°ã‚’èª­ã¿è¾¼ã¿
        const isFirstSave = await loadConfigFromDb('isFirstSave');
        if (isFirstSave !== null) {
          state.isFirstSave = isFirstSave;
        }
        
        // UIã‚’æ›´æ–°
        renderBingoCard();
        renderLeafCollection();
      } catch (error) {
        console.error('ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§å§‹ã‚ã¾ã™ã€‚');
      }
    }
    
    // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderBingoCard() {
      elements.bingoCard.innerHTML = '';
      
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        if (state.selectedCell === i) {
          cell.classList.add('selected');
        }
        
        if (state.bingoCard[i]) {
          // ã‚»ãƒ«ã«è‘‰ã£ã±ãŒã‚ã‚‹å ´åˆ
          const filledCell = document.createElement('div');
          filledCell.className = 'filled-cell';
          
          const img = document.createElement('img');
          img.src = state.bingoCard[i];
          img.className = 'leaf-image';
          img.alt = `è‘‰ã£ã± ${i + 1}`;
          
          filledCell.appendChild(img);
          
          // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ä¸Šã®ã‚»ãƒ«ã«å¯¾å¿œã™ã‚‹è‘‰ã£ã±ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
          const leaf = state.uploadedLeaves.find(leaf => leaf.imageData === state.bingoCard[i]);
          if (leaf && state.leafNotes[leaf.id]) {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'leaf-note';
            noteDiv.textContent = state.leafNotes[leaf.id];
            filledCell.appendChild(noteDiv);
          }
          
          cell.appendChild(filledCell);
          
          // æ—¢ã«ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¢ã‚’ç·¨é›†
          cell.addEventListener('click', () => {
            const leaf = state.uploadedLeaves.find(leaf => leaf.imageData === state.bingoCard[i]);
            if (leaf) {
              openNoteModal(leaf.id);
            }
          });
        } else {
          // ç©ºã®ã‚»ãƒ«
          const emptyCell = document.createElement('div');
          emptyCell.className = 'empty-cell';
          emptyCell.innerHTML = '<span>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è‘‰ã£ã±ã‚’è¿½åŠ </span>';
          cell.appendChild(emptyCell);
          
          // ç©ºã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
          cell.addEventListener('click', () => {
            state.selectedCell = i;
            elements.fileInput.click();
          });
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®å‡¦ç†
        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        
        cell.addEventListener('drop', (e) => {
          e.preventDefault();
          const leafId = e.dataTransfer.getData('leafId');
          if (leafId) {
            const leaf = state.uploadedLeaves.find(l => l.id === parseInt(leafId));
            if (leaf) {
              state.bingoCard[i] = leaf.imageData;
              renderBingoCard();
              saveBingoCardToDb();
            }
          }
        });
        
        elements.bingoCard.appendChild(cell);
      }
    }
    
    // è‘‰ã£ã±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderLeafCollection() {
      if (state.uploadedLeaves.length === 0) {
        elements.leafCollection.style.display = 'none';
        return;
      }
      
      elements.leafCollection.style.display = 'block';
      elements.leafGallery.innerHTML = '';
      
      state.uploadedLeaves.forEach((leaf) => {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'leaf-thumbnail';
        thumbnail.draggable = true;
        
        thumbnail.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('leafId', leaf.id);
        });
        
        thumbnail.addEventListener('click', () => {
          openNoteModal(leaf.id);
        });
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-badge';
        deleteBtn.textContent = 'âŒ';
        deleteBtn.title = 'å‰Šé™¤';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²æ­¢
          if (confirm('ã“ã®è‘‰ã£ã±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            deleteLeaf(leaf.id);
          }
        });
        thumbnail.appendChild(deleteBtn);
        
        // å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆPCç”¨ï¼‰
        thumbnail.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (confirm('ã“ã®è‘‰ã£ã±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            deleteLeaf(leaf.id);
          }
        });
        
        const img = document.createElement('img');
        img.src = leaf.imageData;
        img.alt = `è‘‰ã£ã± ${leaf.id}`;
        
        thumbnail.appendChild(img);
        
        // ãƒ¡ãƒ¢ã¾ãŸã¯æ—¥ä»˜ãŒã‚ã‚Œã°è¡¨ç¤º
        let noteText = '';
        if (state.leafNotes[leaf.id]) {
          noteText = state.leafNotes[leaf.id];
        }
        if (state.leafDates[leaf.id]) {
          const date = new Date(state.leafDates[leaf.id]);
          const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
          if (noteText) {
            noteText = dateStr + ' - ' + noteText;
          } else {
            noteText = dateStr;
          }
        }
        
        if (noteText) {
          const noteDiv = document.createElement('div');
          noteDiv.className = 'thumbnail-note';
          noteDiv.textContent = noteText;
          noteDiv.title = noteText;
          thumbnail.appendChild(noteDiv);
        }
        
        elements.leafGallery.appendChild(thumbnail);
      });
    }
    
    // è‘‰ã£ã±ã‚’å‰Šé™¤
    async function deleteLeaf(leafId) {
      try {
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤
        await deleteLeafFromDb(leafId);
        
        // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‹ã‚‰å‰Šé™¤
        const leafImageData = state.uploadedLeaves.find(l => l.id === leafId)?.imageData;
        if (leafImageData) {
          for (let i = 0; i < state.bingoCard.length; i++) {
            if (state.bingoCard[i] === leafImageData) {
              state.bingoCard[i] = null;
            }
          }
        }
        
        // çŠ¶æ…‹ã‹ã‚‰å‰Šé™¤
        state.uploadedLeaves = state.uploadedLeaves.filter(l => l.id !== leafId);
        delete state.leafNotes[leafId];
        delete state.leafDates[leafId];
        
        // UIã‚’æ›´æ–°
        renderBingoCard();
        renderLeafCollection();
        
        // ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
        await saveBingoCardToDb();
        
        showMessage('è‘‰ã£ã±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        setTimeout(() => {
          elements.nftMessage.style.display = 'none';
        }, 2000);
      } catch (error) {
        console.error('è‘‰ã£ã±ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('è‘‰ã£ã±ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
    
    // ç”»åƒã®ã‚µã‚¤ã‚ºã‚’ç¸®å°ï¼ˆãƒ‡ãƒ¼ã‚¿é‡å‰Šæ¸›ã®ãŸã‚ï¼‰
    function resizeImage(dataURL, maxWidth, maxHeight, quality = 0.7) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
          let width = img.width;
          let height = img.height;
          
          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ãƒªã‚µã‚¤ã‚º
          if (width > maxWidth) {
            height = Math.round(height * (maxWidth / width));
            width = maxWidth;
          }
          
          if (height > maxHeight) {
            width = Math.round(width * (maxHeight / height));
            height = maxHeight;
          }
          
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // åœ§ç¸®ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿URLã‚’è¿”ã™
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        
        img.src = dataURL;
      });
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    async function handleFileUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã®ãƒã‚§ãƒƒã‚¯
      checkStorageUsage();
      
      for (const file of Array.from(files)) {
        try {
          // FileReaderã§ç”»åƒã‚’èª­ã¿è¾¼ã¿
          const imageDataURL = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(file);
          });
          
          // ç”»åƒã®ãƒªã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ¼ã‚¿é‡å‰Šæ¸›ã®ãŸã‚ï¼‰
          const resizedImageData = await resizeImage(imageDataURL, 800, 800, 0.7);
          
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
          const leafId = await saveLeafToDb(resizedImageData);
          
          // çŠ¶æ…‹ã«è¿½åŠ 
          state.uploadedLeaves.push({
            id: leafId,
            imageData: resizedImageData
          });
          
          // é¸æŠä¸­ã®ã‚»ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ãã®ã‚»ãƒ«ã«è‘‰ã£ã±ã‚’é…ç½®
          if (state.selectedCell !== null) {
            state.bingoCard[state.selectedCell] = resizedImageData;
            await saveBingoCardToDb();
            
            // ãƒ¡ãƒ¢å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            openNoteModal(leafId);
            
            // ã‚»ãƒ«é¸æŠã‚’è§£é™¤
            state.selectedCell = null;
          }
          
          // UIã‚’æ›´æ–°
          renderBingoCard();
          renderLeafCollection();
        } catch (error) {
          console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          showMessage('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        }
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
      event.target.value = '';
    }
    
    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã®ãƒã‚§ãƒƒã‚¯
    function checkStorageUsage() {
      // IndexedDBå®¹é‡ã®æ¨å®šã¯é›£ã—ã„ãŸã‚ã€
      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸè‘‰ã£ã±ã®æ•°ã§åˆ¤æ–­
      if (state.uploadedLeaves.length >= 15) {
        elements.storageWarning.style.display = 'block';
      } else {
        elements.storageWarning.style.display = 'none';
      }
    }
    
    // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openNoteModal(leafId) {
      state.selectedLeafIndex = leafId;
      elements.noteInput.value = state.leafNotes[leafId] || '';
      
      // æ—¥ä»˜ãŒã‚ã‚Œã°è¨­å®š
      if (state.leafDates[leafId]) {
        elements.dateInput.value = state.leafDates[leafId];
      } else {
        // ãªã‘ã‚Œã°ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        elements.dateInput.value = `${yyyy}-${mm}-${dd}`;
      }
      
      updateCharCount();
      
      // è‘‰ã£ã±ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      elements.leafPreview.innerHTML = '';
      const leaf = state.uploadedLeaves.find(l => l.id === leafId);
      if (leaf) {
        const previewImg = document.createElement('img');
        previewImg.src = leaf.imageData;
        previewImg.alt = 'è‘‰ã£ã±ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
        elements.leafPreview.appendChild(previewImg);
      }
      
      elements.noteModal.style.display = 'flex';
      
      // ãƒ¢ãƒã‚¤ãƒ«ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if (state.isTouchDevice) {
        setTimeout(() => {
          elements.noteInput.focus();
        }, 300);
      }
    }
    
    // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeNoteModal() {
      elements.noteModal.style.display = 'none';
      state.selectedLeafIndex = null;
    }
    
    // ãƒ¡ãƒ¢ã‚’ä¿å­˜
    async function saveNote() {
      if (state.selectedLeafIndex !== null) {
        const note = elements.noteInput.value.trim();
        const date = elements.dateInput.value;
        
        // ãƒ¡ãƒ¢ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        await saveNoteToDb(state.selectedLeafIndex, note);
        
        // æ—¥ä»˜ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        await saveDateToDb(state.selectedLeafIndex, date);
        
        // çŠ¶æ…‹ã‚’æ›´æ–°
        state.leafNotes[state.selectedLeafIndex] = note;
        state.leafDates[state.selectedLeafIndex] = date;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦UIã‚’æ›´æ–°
        closeNoteModal();
        renderBingoCard();
        renderLeafCollection();
      }
    }
    
    // JPEGã¨ã—ã¦ä¿å­˜
    async function saveAsJpeg() {
      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        showMessage('<div class="loading-spinner"></div> ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ä¸­...');
        
        // åˆå›ä¿å­˜ã®å ´åˆã¯ä¿å­˜æƒ…å ±ã‚’è¡¨ç¤º
        if (state.isFirstSave) {
          elements.saveInfo.style.display = 'block';
          state.isFirstSave = false;
          saveConfigToDb('isFirstSave', false);
        }
        



        // ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è©¦è¡Œ
        setTimeout(async () => {
          try {
            // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã§ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            const canvas = await captureElement(elements.bingoCard);
            
            // ã“ã“ã‹ã‚‰ä¿®æ­£ãƒ»è¿½åŠ éƒ¨åˆ† //
            // ä½™ç™½ã‚’è¿½åŠ ã—ãŸæ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
            const paddedCanvas = document.createElement('canvas');
            const padding = 50; // ä¸Šä¸‹å·¦å³ã®ä½™ç™½ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            paddedCanvas.width = canvas.width + (padding * 2);
            paddedCanvas.height = canvas.height + (padding * 2);
            
            // æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const ctx = paddedCanvas.getContext('2d');
            
            // èƒŒæ™¯è‰²ã‚’è¨­å®šï¼ˆå…ƒã®ã‚¢ãƒ—ãƒªã®èƒŒæ™¯è‰²ã¨åŒã˜ï¼‰
            ctx.fillStyle = '#fff8e1';
            ctx.fillRect(0, 0, paddedCanvas.width, paddedCanvas.height);
            
            // å…ƒã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½™ç™½ã‚’ç©ºã‘ã¦ä¸­å¤®ã«æç”»
            ctx.drawImage(canvas, padding, padding);
            // ã“ã“ã¾ã§ä¿®æ­£ãƒ»è¿½åŠ éƒ¨åˆ† //
            
            // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            link.download = 'ç§‹ã®è‘‰ã£ã±ãƒ“ãƒ³ã‚´.jpg';
            link.href = paddedCanvas.toDataURL('image/jpeg', 0.9); // ã“ã“ã‚’ä¿®æ­£: canvas â†’ paddedCanvas
            link.click();
            
            showMessage('ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            setTimeout(() => {
              elements.nftMessage.style.display = 'none';
            }, 3000);
          } catch (error) {
            console.error('ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }
        }, 500);

      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
    
    // NFTæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    function enableNftButton() {
      elements.saveNftBtn.classList.add('nft-button-enabled');
      elements.saveNftBtn.textContent = 'NFTã¨ã—ã¦ä¿å­˜ ğŸŒŸ';
      elements.saveNftBtn.removeAttribute('disabled');
      state.nftEnabled = true;
      saveConfigToDb('nftEnabled', true);
    }
    
    // NFTæœ‰åŠ¹åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showNftEnableModal() {
      elements.nftEnableModal.style.display = 'flex';
    }
    
    // NFTæœ‰åŠ¹åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeNftEnableModal() {
      elements.nftEnableModal.style.display = 'none';
    }
    
    // NFTã¨ã—ã¦ä¿å­˜ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
    function saveAsNFT() {
      if (!state.nftEnabled) {
        showNftEnableModal();
        return;
      }
      
      showMessage('<div class="loading-spinner"></div> NFTã®ä½œæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸï¼ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã«è¨˜éŒ²ä¸­...');
      
      setTimeout(() => {
        showMessage('ãŠã‚ã§ã¨ã†ï¼ã‚ãªãŸã®ã€Œç§‹ã®è‘‰ã£ã±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€NFTãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚');
        
        setTimeout(() => {
          elements.nftMessage.style.display = 'none';
        }, 5000);
      }, 2000);
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    async function clearData() {
      if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        try {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
          await clearDatabase();
          
          // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          state.bingoCard = Array(9).fill(null);
          state.uploadedLeaves = [];
          state.leafNotes = {};
          state.leafDates = {};
          state.selectedCell = null;
          
          // UIã‚’æ›´æ–°
          renderBingoCard();
          renderLeafCollection();
          elements.storageWarning.style.display = 'none';
          
          showMessage('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
          setTimeout(() => {
            elements.nftMessage.style.display = 'none';
          }, 3000);
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
          showMessage('ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      }
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showMessage(message) {
      elements.nftMessage.innerHTML = message;
      elements.nftMessage.style.display = 'block';
    }
    
    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°
    function updateCharCount() {
      const count = elements.noteInput.value.length;
      elements.charCount.textContent = count;
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    function setupEventListeners() {
      elements.fileInput.addEventListener('change', handleFileUpload);
      elements.saveJpegBtn.addEventListener('click', saveAsJpeg);
      elements.saveNftBtn.addEventListener('click', saveAsNFT);
      elements.clearBtn.addEventListener('click', clearData);
      
      elements.cancelNoteBtn.addEventListener('click', closeNoteModal);
      elements.saveNoteBtn.addEventListener('click', saveNote);
      
      elements.noteInput.addEventListener('input', updateCharCount);
      
      // NFTæœ‰åŠ¹åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³
      elements.cancelNftEnableBtn.addEventListener('click', closeNftEnableModal);
      elements.confirmNftEnableBtn.addEventListener('click', () => {
        enableNftButton();
        closeNftEnableModal();
        saveAsNFT();
      });
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
      elements.noteModal.addEventListener('click', (e) => {
        if (e.target === elements.noteModal) {
          closeNoteModal();
        }
      });
      
      elements.nftEnableModal.addEventListener('click', (e) => {
        if (e.target === elements.nftEnableModal) {
          closeNftEnableModal();
        }
      });
      
      // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã®é•·æŠ¼ã—æ¤œå‡ºï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤ºç”¨ï¼‰
      if (state.isTouchDevice) {
        document.addEventListener('touchstart', (e) => {
          if (e.target.closest('.leaf-thumbnail')) {
            const thumbnail = e.target.closest('.leaf-thumbnail');
            const deleteBtn = thumbnail.querySelector('.delete-badge');
            if (deleteBtn) {
              deleteBtn.style.opacity = '1';
              setTimeout(() => {
                deleteBtn.style.opacity = '0';
              }, 2000);
            }
          }
        });
      }
    }
    
    // ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãƒã‚§ãƒƒã‚¯
    function checkBrowserSupport() {
      // IndexedDBã®ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
      if (!window.indexedDB) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯IndexedDBã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŒã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        return false;
      }
      
      // ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã©ã†ã‹ã®åˆ¤å®š
      if (state.isTouchDevice) {
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®èª¿æ•´ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
        document.documentElement.classList.add('touch-device');
      }
      
      return true;
    }
    
    // ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
    async function initApp() {
      try {
        // ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãƒã‚§ãƒƒã‚¯
        checkBrowserSupport();
        
        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        await loadAppState();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        setupEventListeners();
        
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã®ãƒã‚§ãƒƒã‚¯
        checkStorageUsage();
        
        // ç¾åœ¨ã®æ—¥ä»˜ã‚’è¨­å®š
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        elements.dateInput.value = `${yyyy}-${mm}-${dd}`;
      } catch (error) {
        console.error('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ã‚¢ãƒ—ãƒªã®èµ·å‹•ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
    }
    
    // ã‚¢ãƒ—ãƒªèµ·å‹•
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
